<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>オカズコントローラー Ver 4.6.106</title>
    <style>
        html, body { height: 100%; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
        body { font-family: "Hiragino Maru Gothic ProN", "Yu Gothic", "Meiryo", sans-serif; text-align: center; background: #ffffff; margin: 0; padding: 0; display: flex; flex-direction: column; overflow: hidden; touch-action: none; }
        #tap-guide { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 150px; height: 150px; background: rgba(214, 48, 49, 0.2); border: 6px solid #d63031; border-radius: 50%; z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        #tap-guide::after { content: "ここを\Aタッチ"; font-size: 22px; font-weight: 900; color: #d63031; white-space: pre; line-height: 1.2; text-align: center; }
        .guide-pulse { animation: guide-pulse-animation 1.2s infinite; }
        @keyframes guide-pulse-animation { 0% { transform: translate(-50%, -50%) scale(0.9); box-shadow: 0 0 0 0 rgba(214, 48, 49, 0.7); } 70% { transform: translate(-50%, -50%) scale(1.1); box-shadow: 0 0 0 40px rgba(214, 48, 49, 0); } 100% { transform: translate(-50%, -50%) scale(0.9); box-shadow: 0 0 0 0 rgba(214, 48, 49, 0); } }
        
        #header { background: #fff; padding: calc(5px + env(safe-area-inset-top)) 15px 2px 15px; display: flex; justify-content: space-between; align-items: center; }
        #status { font-size: 0.8rem; font-weight: bold; padding: 4px 12px; border-radius: 20px; min-width: 70px; }
        .status-waiting { background: #ff7675; color: white; animation: pulse 2s infinite; }
        .status-loading { background: #ffeaa7; color: #d35400; }
        .status-ready { background: #ebfbee; color: #1b5e20; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .control-panel { background: #fdfdfd; padding: 5px 0; border-bottom: 1px solid #eee; }
        .slider-row { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 2px 0; }
        .slider-row label { font-size: 0.75rem; font-weight: bold; color: #666; width: 35px; }
        input[type="range"] { -webkit-appearance: none; width: 110px; height: 6px; background: #eee; border-radius: 4px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #3498db; border-radius: 50%; border: 2px solid #fff; }
        .val-disp { font-size: 1.1rem; font-weight: 900; color: #2980b9; min-width: 70px; text-align: left; }

        #main-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; overflow: hidden; background: #f4f4f4; }
        
        /* 枠を固定 */
        #pad-container { 
            position: relative; 
            width: 100%; 
            max-width: 420px; 
            aspect-ratio: 3 / 4; 
            background: white; 
            overflow: hidden; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 呼吸で動く画像とパッドのグループ */
        #breathing-group { 
            position: relative; 
            width: 100%; 
            height: 100%;
            transform-origin: 50% 40%; 
            will-change: transform;
            --y-fixed: -3px; 
            --x-fixed: 1.06; 
        }

        #body-img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        
        /* アニメーション定義 */
        .breathing-trigger { animation: realistic-breath var(--move-duration) cubic-bezier(0.45, 0.05, 0.55, 0.95) forwards; }
        @keyframes realistic-breath { 0%, 100% { transform: scale(1.0) translateY(0px); } 52% { transform: scale(var(--x-fixed), calc(1 + (var(--x-fixed) - 1) * 0.4)) translateY(var(--y-fixed)); } }
        
        .breathing-asthma { animation: asthma-breath 3.2s cubic-bezier(0.45, 0.05, 0.55, 0.95) forwards; }
        @keyframes asthma-breath { 0%, 100% { transform: scale(1.0) translateY(0px); } 21.9% { transform: scale(var(--x-fixed), calc(1 + (var(--x-fixed) - 1) * 0.4)) translateY(var(--y-fixed)); } }

        .pad { position: absolute; width: 13%; height: 9%; background: rgba(255, 255, 255, 0); border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; color: white; cursor: pointer; z-index: 10; transform: translate(-50%, -50%); }
        .active-pad { background: rgba(231, 76, 60, 0.8) !important; border-color: #ffcccc; }

        .selector-container { background: #fff; padding-bottom: calc(5px + env(safe-area-inset-bottom)); border-top: 1px solid #eee; }
        .scroll-row { overflow-x: auto; white-space: nowrap; padding: 6px 0; border-bottom: 1px solid #f9f9f9; scroll-behavior: smooth; }
        .scroll-row::-webkit-scrollbar { display: none; }
        .label-tag { font-size: 0.6rem; color: #aaa; text-align: left; padding-left: 15px; display: block; margin-top: 4px; }
        .btn { display: inline-block; padding: 10px 18px; margin: 0 5px; font-size: 0.9rem; font-weight: bold; border: none; border-radius: 20px; background: #f0f0f0; color: #666; }
        .btn.active { background: #3498db; color: white; }
        .btn.heart-btn.active { background: #e74c3c; }
    </style>
</head>
<body>
    <div id="tap-guide" class="guide-pulse" onclick="initAudio()"></div>
    <div id="header"><div id="status" class="status-waiting">待機中</div><div style="font-size: 0.6rem; color: #ccc;">Ver 4.6.106</div></div>

    <div class="control-panel" id="no-touch-zone">
        <div class="slider-row"><label>呼吸</label><input type="range" id="rr-slider" min="10" max="25" step="1" value="18"><div class="val-disp"><span id="rr-val">18</span><small>回</small></div></div>
        <div class="slider-row"><label>心拍</label><input type="range" id="hr-slider" min="40" max="120" step="1" value="70"><div class="val-disp"><span id="hr-val">70</span><small>bpm</small></div></div>
    </div>

    <div id="main-content">
        <div id="pad-container">
            <div id="breathing-group">
                <img src="body_image.jpg" alt="body" id="body-img">
                <div class="pad" id="pad-btn9" style="top: 30%; left: 50%;">9</div>
                <div class="pad" id="pad-btn1" style="top: 32%; left: 30%;">1</div>
                <div class="pad" id="pad-btn2" style="top: 32%; left: 70%;">2</div>
                <div class="pad" id="pad-btn3" style="top: 45%; left: 33%;">3</div>
                <div class="pad" id="pad-btn4" style="top: 45%; left: 67%;">4</div>
                <div class="pad" id="pad-btn5" style="top: 59%; left: 37%;">5</div>
                <div class="pad" id="pad-btn6" style="top: 59%; left: 63%;">6</div>
                <div class="pad" id="pad-btn7" style="top: 57%; left: 18%;">7</div>
                <div class="pad" id="pad-btn8" style="top: 57%; left: 82%;">8</div>
            </div>
        </div>
    </div>

    <div class="selector-container">
        <span class="label-tag">呼吸音症例</span>
        <div id="lung-row" class="scroll-row">
            <button class="btn lung-btn active" data-folder="normal">正常呼吸音</button>
            <button class="btn lung-btn" data-folder="fc">間質性肺炎</button>
            <button class="btn lung-btn" data-folder="left_pneumo">右気胸</button>
            <button class="btn lung-btn" data-folder="right_pneumo">左気胸</button>
            <button class="btn lung-btn" data-folder="asthma">喘息発作</button>
            <button class="btn lung-btn" data-folder="pleuritis">胸膜炎</button>
        </div>
        <span class="label-tag">心音症例</span>
        <div id="heart-row" class="scroll-row">
            <button class="btn heart-btn active" data-folder="none">なし</button>
            <button class="btn heart-btn" data-folder="normal">正常心音</button>
            <button class="btn heart-btn" data-folder="as">AS</button>
            <button class="btn heart-btn" data-folder="ms">MS</button>
            <button class="btn heart-btn" data-folder="mr">MR</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        let audioStarted = false;
        let players = { normal_v: null, extra_v: null, bronchial: null, heart: null };
        let rrValue = 18, hrValue = 70;
        let lungFolder = "normal", heartFolder = "none";
        let masterLoop = null, heartLoop = null, activePadId = null;

        async function initAudio() {
            if (audioStarted) return;
            await Tone.start();
            audioStarted = true;
            document.getElementById('tap-guide').remove();
            loadLungSounds();
        }

        function loadLungSounds() {
            const status = document.getElementById('status');
            status.innerText = "読込中..."; status.className = "status-loading";
            ['normal_v','extra_v','bronchial'].forEach(k => players[k] && players[k].dispose());
            if (masterLoop) masterLoop.dispose();

            const paths = {
                normal_v: `./soundsource/normal/vesicular.wav`,
                extra_v: `./soundsource/${lungFolder}/vesicular.wav`,
                bronchial: `./soundsource/${lungFolder}/bronchial.wav`
            };
            if (lungFolder === "asthma") paths.extra_v = `./soundsource/${lungFolder}/wheeze.wav`;
            if (lungFolder === "fc") paths.extra_v = `./soundsource/${lungFolder}/fine_crackles.wav`;
            if (lungFolder === "pleuritis") paths.extra_v = `./soundsource/${lungFolder}/friction_rub.wav`;

            let loaded = 0;
            Object.keys(paths).forEach(key => {
                players[key] = new Tone.Player({ url: paths[key], volume: -Infinity, onload: () => {
                    if (++loaded === 3) { status.innerText = "準備完了"; status.className = "status-ready"; startLungLoop(); }
                }}).toDestination();
            });
            loadHeartSound();
        }

        function loadHeartSound() {
            if (players.heart) players.heart.dispose();
            if (heartLoop) heartLoop.dispose();
            if (heartFolder === "none") return;
            players.heart = new Tone.Player({
                url: `./soundsource/heart/${heartFolder}.wav`, volume: -Infinity,
                onload: () => { heartLoop = new Tone.Loop(time => players.heart.start(time), 60/hrValue).start(0); }
            }).toDestination();
        }

        function startLungLoop() {
            masterLoop = new Tone.Loop(time => {
                ['normal_v','extra_v','bronchial'].forEach(k => players[k] && players[k].start(time));
                Tone.Draw.schedule(() => {
                    const bg = document.getElementById('breathing-group');
                    bg.classList.remove('breathing-trigger', 'breathing-asthma');
                    void bg.offsetWidth;
                    bg.classList.add(lungFolder === "asthma" ? 'breathing-asthma' : 'breathing-trigger');
                }, time);
            }, 60/rrValue).start(0);
            Tone.Transport.start();
            updateAnimations();
        }

        function setVolume(id, isOn) {
            if (!audioStarted) return;
            if (isOn) {
                let target = (id == 9) ? players.bronchial : players.extra_v;
                let vol = 0;
                if (lungFolder === "fc" && ![5,6,7,8].includes(id)) target = players.normal_v;
                if (lungFolder === "left_pneumo" && [1,3,5,7].includes(id)) vol = -25;
                if (lungFolder === "right_pneumo" && [2,4,6,8].includes(id)) vol = -25;
                if (target) target.volume.rampTo(vol, 0.1);
                if (players.heart) players.heart.volume.rampTo(-5, 0.1);
                document.getElementById(`pad-btn${id}`).classList.add('active-pad');
            } else {
                ['normal_v','extra_v','bronchial','heart'].forEach(k => players[k] && players[k].volume.rampTo(-Infinity, 0.2));
                document.querySelectorAll('.pad').forEach(p => p.classList.remove('active-pad'));
            }
        }

        function updateAnimations() {
            const interval = 60 / rrValue;
            let dur = (lungFolder === "asthma") ? 3.2 : (rrValue <= 18 ? 2.5 : interval);
            document.documentElement.style.setProperty('--move-duration', `${dur}s`);
        }

        document.getElementById('rr-slider').addEventListener('input', e => {
            rrValue = parseInt(e.target.value); document.getElementById('rr-val').innerText = rrValue;
            if (masterLoop) masterLoop.interval = 60/rrValue; updateAnimations();
        });
        document.getElementById('hr-slider').addEventListener('input', e => {
            hrValue = parseInt(e.target.value); document.getElementById('hr-val').innerText = hrValue;
            if (heartLoop) heartLoop.interval = 60/hrValue;
        });

        document.querySelectorAll('.lung-btn').forEach(btn => btn.addEventListener('click', () => {
            lungFolder = btn.dataset.folder;
            document.querySelectorAll('.lung-btn').forEach(b => b.classList.toggle('active', b === btn));
            loadLungSounds();
        }));
        document.querySelectorAll('.heart-btn').forEach(btn => btn.addEventListener('click', () => {
            heartFolder = btn.dataset.folder;
            document.querySelectorAll('.heart-btn').forEach(b => b.classList.toggle('active', b === btn));
            loadHeartSound();
        }));

        document.querySelectorAll('.pad').forEach(p => {
            const id = parseInt(p.id.replace('pad-btn',''));
            p.addEventListener('pointerdown', () => { if(!activePadId){ activePadId=id; setVolume(id,true); }});
            const stop = () => { if(activePadId==id){ setVolume(id,false); activePadId=null; }};
            ['pointerup','pointerleave','pointercancel'].forEach(ev => p.addEventListener(ev, stop));
        });
    </script>
</body>
</html>
