<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>オカズコントローラー Ver 4.6.88</title>
    <style>
        html, body { height: 100%; }
        body { 
            font-family: "Hiragino Maru Gothic ProN", "Yu Gothic", "Meiryo", sans-serif; 
            text-align: center; background: #ffffff; margin: 0; padding: 0; 
            display: flex; flex-direction: column; overflow: hidden; touch-action: none;
        }

        /* 赤色パルス開始スイッチ */
        #tap-guide {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 150px; height: 150px; background: rgba(214, 48, 49, 0.2);
            border: 6px solid #d63031; border-radius: 50%; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: opacity 0.5s;
        }
        #tap-guide::after {
            content: "ここを\Aタッチ"; font-size: 22px; font-weight: 900; color: #d63031; 
            white-space: pre; line-height: 1.2; text-align: center;
        }
        .guide-pulse { animation: guide-pulse-animation 1.2s infinite; }
        @keyframes guide-pulse-animation {
            0% { transform: translate(-50%, -50%) scale(0.9); box-shadow: 0 0 0 0 rgba(214, 48, 49, 0.7); }
            70% { transform: translate(-50%, -50%) scale(1.1); box-shadow: 0 0 0 40px rgba(214, 48, 49, 0); }
            100% { transform: translate(-50%, -50%) scale(0.9); box-shadow: 0 0 0 0 rgba(214, 48, 49, 0); }
        }

        #header { background: #fff; padding: calc(10px + env(safe-area-inset-top)) 15px 5px 15px; display: flex; justify-content: space-between; align-items: center; }
        #status { font-size: 0.85rem; font-weight: bold; padding: 5px 14px; border-radius: 20px; min-width: 75px; }
        .status-waiting { background: #ff7675; color: white; animation: pulse 2s infinite; }
        .status-ready { background: #ebfbee; color: #1b5e20; border: 1px solid #2e7d32; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .speed-control { width: 100%; background: #fff; padding: 5px 0 12px 0; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: center; gap: 8px; }
        #rr-slider { -webkit-appearance: none; width: 120px; height: 8px; background: #eee; border-radius: 4px; outline: none; }
        #rr-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: #3498db; border-radius: 50%; border: 2px solid #fff; }
        #rr-display { font-size: 1.8rem; font-weight: 900; color: #2980b9; min-width: 95px; text-align: right; }

        #main-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #ffffff; overflow: hidden; position: relative; }
        #pad-container { position: relative; width: 100%; max-width: 420px; background: white; overflow: hidden; }

        #breathing-group {
            position: relative; width: 100%; line-height: 0;
            will-change: transform; transform-origin: 50% 45%;
        }

        #body-img { width: 100%; height: auto; display: block; pointer-events: none; }

        /* 喘息以外の呼吸（吸気1.3s : 呼気1.2s = 52% : 48% / 合計2.5s） */
        .breathing-trigger { animation: chest-expand-all var(--move-duration) ease-in-out forwards; }
        @keyframes chest-expand-all {
            0% { transform: scale(1.0); }
            52% { transform: scale(1.05); } 
            100% { transform: scale(1.0); }
        }

        /* 喘息（吸気0.7s : 呼気2.5s = 21.9% : 78.1% / 合計3.2s） */
        .breathing-asthma { animation: asthma-expand 3.2s ease-in-out forwards; }
        @keyframes asthma-expand {
            0% { transform: scale(1.0); }
            21.9% { transform: scale(1.05); } 
            100% { transform: scale(1.0); }  
        }

        .pad { position: absolute; width: 13%; height: 9%; background: rgba(255, 255, 255, 0); border: 2px solid white; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; cursor: pointer; z-index: 10; transform: translate(-50%, -50%); }
        .pad.btn7, .pad.btn8 { width: 10%; height: 14%; }
        .pad.active-pad { background: rgba(231, 76, 60, 0.8) !important; border-color: #ffcccc; }

        .dial-container { width: 100%; background: #ffffff; padding: 10px 0 calc(20px + env(safe-area-inset-bottom)) 0; overflow-x: auto; white-space: nowrap; }
        .sound-btn { display: inline-block; padding: 14px 28px; margin: 0 8px; font-size: 1.3rem; font-weight: bold; border: none; border-radius: 30px; background: #f8f8f8; color: #555; }
        .sound-btn.active { background: #3498db; color: white; }
    </style>
</head>
<body>

    <div id="tap-guide" class="guide-pulse" onclick="initAudio()"></div>

    <div id="header">
        <div id="status" class="status-waiting">待機中</div>
        <div style="font-size: 0.65rem; color: #bbb;">Ver 4.6.88</div>
    </div>

    <div class="speed-control">
        <label>呼吸回数</label>
        <input type="range" id="rr-slider" min="10" max="25" step="1" value="18">
        <div id="rr-display"><span id="rr-val">18</span><small>回/分</small></div>
    </div>

    <div id="main-content">
        <div id="pad-container">
            <div id="breathing-group">
                <img src="body_image.jpg" alt="body" id="body-img">
                <div class="pad btn9" id="pad-btn9" style="top: 30%; left: 50%;">9</div>
                <div class="pad btn1" id="pad-btn1" style="top: 32%; left: 30%;">1</div>
                <div class="pad btn2" id="pad-btn2" style="top: 32%; left: 70%;">2</div>
                <div class="pad btn3" id="pad-btn3" style="top: 45%; left: 33%;">3</div>
                <div class="pad btn4" id="pad-btn4" style="top: 45%; left: 67%;">4</div>
                <div class="pad btn5" id="pad-btn5" style="top: 59%; left: 37%;">5</div>
                <div class="pad btn6" id="pad-btn6" style="top: 59%; left: 63%;">6</div>
                <div class="pad btn7" id="pad-btn7" style="top: 57%; left: 18%;">7</div>
                <div class="pad btn8" id="pad-btn8" style="top: 57%; left: 82%;">8</div>
            </div>
        </div>
    </div>

    <div class="dial-container">
        <button class="sound-btn active" data-folder="normal">正常呼吸音</button>
        <button class="sound-btn" data-folder="fc">間質性肺炎</button>
        <button class="sound-btn" data-folder="left_pneumo">右気胸</button>
        <button class="sound-btn" data-folder="right_pneumo">左気胸</button>
        <button class="sound-btn" data-folder="asthma">喘息発作</button>
        <button class="sound-btn" data-folder="pleuritis">胸膜炎</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        let audioStarted = false;
        let players = { normal_v: null, extra_v: null, bronchial: null };
        let rrValue = 18;
        let currentFolder = "normal";
        let masterLoop = null;
        const soundBtns = Array.from(document.querySelectorAll('.sound-btn'));
        const breathingGroup = document.getElementById('breathing-group');
        const rrSlider = document.getElementById('rr-slider');

        async function initAudio() {
            if (audioStarted) return;
            await Tone.start();
            audioStarted = true;
            const guide = document.getElementById('tap-guide');
            guide.style.opacity = '0';
            setTimeout(() => { guide.remove(); }, 500);
            loadPlayers(currentFolder);
        }

        function loadPlayers(folder) {
            Object.values(players).forEach(p => { if(p) p.dispose(); });
            if (masterLoop) masterLoop.dispose();
            const paths = {
                normal_v: `./soundsource/normal/vesicular.wav`,
                extra_v: `./soundsource/${folder}/vesicular.wav`,
                bronchial: `./soundsource/${folder}/bronchial.wav`
            };
            if (folder === "asthma") paths.extra_v = `./soundsource/${folder}/wheeze.wav`;
            if (folder === "fc") paths.extra_v = `./soundsource/${folder}/fine_crackles.wav`;
            if (folder === "pleuritis") paths.extra_v = `./soundsource/${folder}/friction_rub.wav`;

            let loadedCount = 0;
            Object.keys(paths).forEach(key => {
                players[key] = new Tone.Player({
                    url: paths[key], loop: false, volume: -Infinity,
                    onload: () => {
                        loadedCount++;
                        if (loadedCount === 3) {
                            document.getElementById('status').innerText = "準備完了";
                            document.getElementById('status').className = "status-ready";
                            startMasterRhythm();
                        }
                    }
                }).toDestination();
            });
        }

        function startMasterRhythm() {
            const interval = 60 / rrValue;
            updateRR(rrValue);
            masterLoop = new Tone.Loop(time => {
                Object.values(players).forEach(p => p.start(time));
                Tone.Draw.schedule(() => {
                    breathingGroup.classList.remove('breathing-trigger', 'breathing-asthma');
                    void breathingGroup.offsetWidth;
                    if (currentFolder === "asthma") {
                        breathingGroup.classList.add('breathing-asthma');
                    } else {
                        breathingGroup.classList.add('breathing-trigger');
                    }
                }, time);
            }, interval).start(0);
            Tone.Transport.start();
        }

        function setVolume(id, isOn) {
            if (!audioStarted || !players.extra_v) return;
            if (isOn) {
                let target; let vol = 0;
                if (currentFolder === "fc") {
                    if ([5, 6, 7, 8].includes(id)) target = players.extra_v;
                    else if ([1, 2, 3, 4].includes(id)) target = players.normal_v;
                    else if (id == 9) target = players.bronchial;
                } else {
                    if (id == 9) target = players.bronchial;
                    else target = players.extra_v;
                    if (currentFolder === "left_pneumo" && [1,3,5,7].includes(id)) vol = -25;
                    if (currentFolder === "right_pneumo" && [2,4,6,8].includes(id)) vol = -25;
                }
                if(target) target.volume.rampTo(vol, 0.1);
                const pad = document.getElementById(`pad-btn${id}`);
                if(pad) pad.classList.add('active-pad');
            } else {
                Object.values(players).forEach(p => p.volume.rampTo(-Infinity, 0.2));
                document.querySelectorAll('.pad').forEach(p => p.classList.remove('active-pad'));
            }
        }

        function updateRR(val) {
            val = Math.max(10, Math.min(25, val));
            rrValue = val;
            rrSlider.value = val;
            document.getElementById('rr-val').innerText = val;
            const interval = 60 / rrValue;

            let moveDuration;
            if (currentFolder === "asthma") {
                moveDuration = 3.2; // 0.7s + 2.5s 固定
            } else if (rrValue <= 18) {
                // 18回以下のときは、1.3s吸気/1.2s呼気の合計2.5s固定
                moveDuration = 2.5; 
            } else {
                moveDuration = interval;
            }
            document.documentElement.style.setProperty('--move-duration', `${moveDuration}s`);

            if (masterLoop) masterLoop.interval = interval;
        }

        document.querySelectorAll('.pad').forEach(p => {
            const id = parseInt(p.id.replace('pad-btn', ''));
            p.addEventListener('touchstart', (e) => { e.preventDefault(); setVolume(id, true); });
            p.addEventListener('touchend', (e) => { e.preventDefault(); setVolume(id, false); });
            p.addEventListener('mousedown', (e) => { e.preventDefault(); setVolume(id, true); });
            p.addEventListener('mouseup', () => setVolume(id, false));
        });

        soundBtns.forEach(b => b.addEventListener('click', () => {
            soundBtns.forEach(btn => btn.classList.remove('active'));
            b.classList.add('active');
            currentFolder = b.dataset.folder;
            updateRR(rrValue);
            if (audioStarted) loadPlayers(currentFolder);
            b.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        }));

        rrSlider.addEventListener('input', (e) => updateRR(parseInt(e.target.value)));
    </script>
</body>
</html>
