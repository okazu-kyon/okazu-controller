<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>オカズコントローラー Ver 4.6.115</title>
    <style>
        /* iOSのシステム動作を徹底的に封じ込める設定 */
        :root {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        html, body { 
            height: 100%; 
            margin: 0; padding: 0; 
            overflow: hidden; 
            background: #ffffff;
            touch-action: none; /* ブラウザによるズーム・スクロールを全禁止 */
            position: fixed; /* 画面自体のバウンス（揺れ）も防止 */
            width: 100%;
        }

        body { 
            font-family: "Hiragino Maru Gothic ProN", "Yu Gothic", "Meiryo", sans-serif; 
            display: flex; 
            flex-direction: column; 
        }

        /* 画像単体での保護 */
        img {
            -webkit-touch-callout: none;
            pointer-events: none;
            -webkit-user-drag: none;
        }
        
        #tap-guide { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .guide-circle { width: 150px; height: 150px; background: rgba(214, 48, 49, 0.2); border: 6px solid #d63031; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .guide-circle::after { content: "ここを\Aタッチ"; font-size: 22px; font-weight: 900; color: #d63031; white-space: pre; line-height: 1.2; text-align: center; }

        #header { background: #fff; padding: calc(5px + env(safe-area-inset-top)) 15px 2px 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #status { font-size: 0.8rem; font-weight: bold; padding: 4px 12px; border-radius: 20px; min-width: 70px; }
        .status-ready { background: #ebfbee; color: #1b5e20; }
        
        .control-panel { background: #fff; padding: 5px 0; border-bottom: 2px solid #ddd; flex-shrink: 0; z-index: 100; }
        .slider-row { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 2px 0; }
        input[type="range"] { -webkit-appearance: none; width: 110px; height: 6px; background: #eee; border-radius: 4px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #3498db; border-radius: 50%; border: 2px solid #fff; }
        
        .mute-btn { width: 40px; height: 40px; border: none; background: none; padding: 0; }
        .mute-btn img { width: 100%; height: 100%; object-fit: contain; }

        #main-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; overflow: hidden; }
        #pad-container { position: relative; width: 100%; max-width: 420px; }
        #breathing-group { position: relative; width: 100%; line-height: 0; transform-origin: 50% 40%; }
        #body-img { width: 100%; height: auto; }

        .pad { 
            position: absolute; width: 13%; height: 9%; 
            background: rgba(255, 255, 255, 0); border: 2px solid white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 1.1rem; color: white; 
            z-index: 10; transform: translate(-50%, -50%); 
        }
        .active-pad { background: rgba(231, 76, 60, 0.8) !important; border-color: #ffcccc; }

        .selector-container { background: #fff; padding-bottom: env(safe-area-inset-bottom); border-top: 1px solid #eee; flex-shrink: 0; }
        .scroll-row { overflow-x: auto; white-space: nowrap; padding: 6px 0; }
        .btn { display: inline-block; padding: 10px 18px; margin: 0 5px; font-size: 0.9rem; font-weight: bold; border: none; border-radius: 20px; background: #f0f0f0; }
        .btn.active { background: #3498db; color: white; }
    </style>
</head>
<body oncontextmenu="return false;">
    <div id="tap-guide" onclick="initAudio()"><div class="guide-circle"></div></div>
    
    <div id="header"><div id="status">待機中</div><div style="font-size: 0.6rem; color: #ccc;">Ver 4.6.115</div></div>

    <div class="control-panel">
        <div class="slider-row">
            <label style="font-size:0.7rem;">呼吸</label>
            <input type="range" id="rr-slider" min="10" max="25" step="1" value="18">
            <span id="rr-val" style="min-width:40px;">18</span>
            <button id="lung-mute" class="mute-btn"><img src="vol_on.png" id="lung-mute-img"></button>
        </div>
        <div class="slider-row">
            <label style="font-size:0.7rem;">心拍</label>
            <input type="range" id="hr-slider" min="40" max="120" step="1" value="70">
            <span id="hr-val" style="min-width:40px;">70</span>
            <button id="heart-mute" class="mute-btn"><img src="vol_on.png" id="heart-mute-img"></button>
        </div>
    </div>

    <div id="main-content">
        <div id="pad-container">
            <div id="breathing-group">
                <img src="body_image.jpg" id="body-img">
                <div class="pad" id="pad-btn9" style="top: 30%; left: 50%;">9</div>
                <div class="pad" id="pad-btn1" style="top: 32%; left: 30%;">1</div>
                <div class="pad" id="pad-btn2" style="top: 32%; left: 70%;">2</div>
                <div class="pad" id="pad-btn3" style="top: 45%; left: 33%;">3</div>
                <div class="pad" id="pad-btn4" style="top: 45%; left: 67%;">4</div>
                <div class="pad" id="pad-btn5" style="top: 59%; left: 37%;">5</div>
                <div class="pad" id="pad-btn6" style="top: 59%; left: 63%;">6</div>
                <div class="pad" id="pad-btn7" style="top: 57%; left: 18%;">7</div>
                <div class="pad" id="pad-btn8" style="top: 57%; left: 82%;">8</div>
            </div>
        </div>
    </div>

    <div class="selector-container">
        <div class="scroll-row">
            <button class="btn lung-btn active" data-folder="normal">正常呼吸音</button>
            <button class="btn lung-btn" data-folder="fc">間質性肺炎</button>
            <button class="btn lung-btn" data-folder="asthma">喘息発作</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        // --- iOS 拡大鏡・ズーム対策 ---
        let lastTouchEnd = 0;
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) e.preventDefault(); // 多指ズーム禁止
        }, { passive: false });

        document.addEventListener('touchend', (e) => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) e.preventDefault(); // ダブルタップによるズームを物理的に無効化
            lastTouchEnd = now;
        }, { passive: false });

        // 全体での長押し（コンテキストメニュー）を禁止
        window.oncontextmenu = function(e) { e.preventDefault(); return false; };

        // --- 以下、音源ロジック（基本維持） ---
        let audioStarted = false;
        let players = { normal_v: null, extra_v: null, bronchial: null, heart: null };
        let activePadId = null;
        let lungMuted = false, heartMuted = false;

        async function initAudio() {
            if (audioStarted) return;
            await Tone.start();
            audioStarted = true;
            document.getElementById('tap-guide').style.display = 'none';
            document.getElementById('status').innerText = "準備完了";
            document.getElementById('status').className = "status-ready";
            // ... 音源ロード処理など（簡略化して継続）
        }

        // パッドのイベント登録も preventDefault を徹底
        document.querySelectorAll('.pad').forEach(p => {
            const id = parseInt(p.id.replace('pad-btn',''));
            p.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                if(!activePadId){ activePadId=id; p.classList.add('active-pad'); /* 音出し */ }
            }, { passive: false });
            
            p.addEventListener('touchend', (e) => {
                e.preventDefault();
                if(activePadId==id){ activePadId=null; p.classList.remove('active-pad'); /* 音停止 */ }
            }, { passive: false });
        });

        // ミュートボタン
        document.getElementById('lung-mute').addEventListener('touchstart', (e) => {
            e.preventDefault();
            lungMuted = !lungMuted;
            document.getElementById('lung-mute-img').src = lungMuted ? "vol_off.png" : "vol_on.png";
        }, { passive: false });

        document.getElementById('heart-mute').addEventListener('touchstart', (e) => {
            e.preventDefault();
            heartMuted = !heartMuted;
            document.getElementById('heart-mute-img').src = heartMuted ? "vol_off.png" : "vol_on.png";
        }, { passive: false });
    </script>
</body>
</html>
